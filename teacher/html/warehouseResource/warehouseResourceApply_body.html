<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    	<meta name="apple-mobile-web-app-capable" content="yes">
    	<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>仓库资源申请</title>
		<link rel="stylesheet" href="../../css/api.css" />
		<link rel="stylesheet" href="../../css/commonWindow.css" />
		<link rel="stylesheet" href="../../css/layui.mobile.css" />
		<!-- 时间插件 -->
		<link href="../../css/dateSelect.css" rel="stylesheet">
		<style type="text/css">
			body{
				min-width: 320px;
                background:#FFFFFF;
			}
            .apply-info{
                width:100%;
                padding-top:7px;
                padding-left:18px;
                padding-right:18px;
                box-sizing: border-box;
            }
            .info-list{
                width:100%;
                box-sizing: border-box;
            }
            .info-list .list-item{
                width:100%;
                height:40px;
                margin-top:5px;
                border: 1px solid #D7D7D7;
                border-radius: 4px;
                box-sizing: border-box;
            }
            .list-tag{
                width:101px;
                height:40px;
                padding-top:9px;
                float:left;
                box-sizing: border-box;
            }
            .list-tag>div{
                width:100%;
                height:23px;
                line-height:23px;
                border-right:1px solid #D7D7D7;
                font-size: 14px;
                text-align: left;
                padding-left:18px;
                color: #333333;
                box-sizing: border-box;
            }
            .list-item>:nth-child(2){
                font-size: 14px;
                color: #333333;
                line-height:40px;
                float:left;
                margin-left:18px;
				width: 60%;
				height: 100%;
            }
			.list-item>:nth-child(2) input{
				padding-left: 5px;
			}
			#pickDateBtn{
				width: 100%;
				height: 100%;
			}
			#myselectName,
			#myselectUse,
			#myselectWname,
			#myselectClass{
				width: 100%;
				height: 38px;
				background: url("../../icon/switch.png") no-repeat scroll right center transparent;
				background-size:5%;
       		 }
        .switch-btn{
            float:right;
            margin-right:18px;
            margin-top:12px;
        }
        .switch-btn>img{
            width:9px;
        }
        .remark{
            width:100%;
			height: 180px;
            border: 1px solid #D7D7D7;
            border-radius: 4px;
            margin-top:5px;
            padding:9px 18px;
            box-sizing: border-box;
        }
        .remark-title{
            font-size: 14px;
            color: #333333;
        }
        .remark-input textarea{
            width:100%;
            height:44px;
            outline: none;
            resize: none;
            font-size: 16px;
            color: #505050;
            line-height:22px;
        }
        .add-other{
            width:41px;
            height:41px;
            border: 1px solid #D7D7D7;
            border-radius: 4px;
            background:url('../../icon/addremark.png');
            background-repeat:no-repeat;
            background-size:18px 18px;
            background-position:center;
			float: left;
        }
		#imglist1 span{
			width:41px;
			height:41px;
			position:relative;
			float: left;
			margin-right:10px;
			margin-bottom:10px;
			display: block;
		}
		#imglist1 span img{
			display: block;
		}
		#imglist1 span i{
			width:10px;
			height:10px;
			background: #ccc;
			border-radius: 50%;
			line-height: 10px;
			text-align: center;
			position:absolute;
			right:2px;
			top:2px;
			color:red;
			font-size:8px;
		}
        .submit{
            width:90.4%;
            height:44px;
            margin:40px auto;
            font-size: 16px;
            color: #FFFFFF;
            letter-spacing: 0.27px;
            text-align: center;
            line-height:44px;
            background: #5AC8E1;
            box-shadow: 0 2px 4px 0 rgba(90,200,225,0.30);
            border-radius: 4px;
        }
</style>
	</head>
	<body id="body">
		<div class="apply-info">
            <ul class="info-list">
                <li class="a-date list-item">
                    <div class="list-tag">
                        <div>申请日期</div>
                    </div>
                    <div>
						<input type="text"  id="pickDateBtn" readonly="readonly" placeholder="请选择申请日期">
					</div>
                </li>
                <li class="a-select list-item">
                    <div class="list-tag">
                        <div>选择仓库</div>
                    </div>
                    <div>
						<select lay-verify="" id="myselectName" >
							<option value="">请选择仓库名称</option>
						</select>
                    </div>

                </li>
                <li class="a-type list-item">
                    <div class="list-tag">
                        <div>资产类别</div>
                    </div>
                    <div>
						<select lay-verify="" id="myselectClass" >
							<option value="">请选择资产类别</option>
						</select>
					</div>

                </li>
                <li class="a-name list-item">
                    <div class="list-tag">
                        <div>物品名称</div>
                    </div>
                    <div >
						<select lay-verify="" id="myselectWname">
							<option value="0">请选择物品名称</option>
						</select>
					</div>

                </li>
				<li class="a-use list-item">
					<div class="list-tag">
						<div>使用部门</div>
					</div>
					<div>
						<select lay-verify="" id="myselectUse">
							<option value="0">请选择使用部门</option>
						</select>
					</div>
				</li>
                <li class="a-use list-item">
                    <div class="list-tag">
                        <div>资产编号</div>
                    </div>
                    <div>
						<input type="number" id="myselectCode" placeholder="资产编号" readonly>
					</div>
                </li>
				<li class="a-count list-item">
					<div class="list-tag">
						<div>现有数</div>
					</div>
					<div>
						<input type="number" id="nowNum" readonly>
					</div>
				</li>
				<li class="apl-num list-item">
					<div class="list-tag">
						<div>申请数</div>
					</div>
					<div>
						<input type="number" id="applyNum" placeholder="请输入申请数" onkeyup="value=value.replace(/[^\d]/g,'')">
					</div>
				</li>
            </ul>
			<div class="remark">
				<div class="remark-title">备注</div>
				<div class="remark-input">
					<textarea name="" id="desc" cols="30" rows="10"></textarea>
				</div>
				<div id="imglist1"></div>
				<div class="add-other" onclick="uploadImg()"></div>
			</div>
        </div>
        <div class="submit" onclick="apply()">提交</div>
	</body>
	<script type="text/javascript" src="../../script/api.js"></script>
	<script type="text/javascript" src="../../script/mui.min.js"></script>
	<script type="text/javascript" src="../../script/layui.min.js"></script>
	<script type="text/javascript" src="../../script/util.js"></script>
	<script type="text/javascript" src="../../script/user.js"></script>
	<script type="text/javascript" src="../../script/kv.js"></script>
	<script type="text/javascript" src="../../script/apiCloud.js"></script>
	<script type="text/javascript" src="../../script/public.js"></script>
	<script type="text/javascript" src="../../script/template-native.js"></script>
	<script type="text/javascript" src="../../script/data.js"></script>
    <script type="text/javascript" src="../../script/jquery-1.8.1.min.js"></script>
    <script type="text/javascript" src="../../script/dateSelect.js"></script>
	<script>
        var imglist = [];
        var List;
		apiready = function () {
			$("#pickDateBtn").dateSelect();
            // 级联数据请求
            ajaxGet(getWarehouseData,{sid:getUserInfo().sid},function(ret,err){
                if(ret.success){
                    if (isNotBlack(ret.data)) {
                        List = tryJsonParse(ret);
                    }
                    initSelect();
                    //获取部门
                    getDepartment();
                }
            });
        };
        var warNameD = document.getElementById('myselectName');
        var classD = document.getElementById('myselectClass');
        var nameD = document.getElementById('myselectWname');
        var codeD = document.getElementById('myselectCode');
        var useD = document.getElementById('myselectUse');


        //  获取部门 直接初始化调用
        function getDepartment(){
            var op = '<option value="0">请选择使用部门</option>';
            for(var key in List.data.departmentSelects){
                useD.innerHTML = op += "<option value='"+ key +"'>" + List.data.departmentSelects[key] + "</option>";
            };
        };

        //  联动数据解析 初始化
        function initSelect(){
            var op = '<option value="0">请选择仓库名称</option>';
            for(var key in List.data.wareHouseSelects){
                warNameD.innerHTML = op += "<option value='"+ key +"'>" + List.data.wareHouseSelects[key] + "</option>";
            };
        };
        warNameD.onchange= function(){
            getClass();
        };

        //获取资产类别
        function getClass(){
            var op = '<option value="0">请选择资产类别</option>';
            var warId = warNameD.value;
            if( warId != 0 ){
                for(var key in List.data.widKindSelects[warId]){
                    classD.innerHTML = op += "<option value='"+ key +"'>" + List.data.widKindSelects[warId][key] + "</option>";
                };
            }
        };
        classD.onchange= function(){
            gatWarName();
        };

        // 物品名称
        function gatWarName(){
            var op = '<option value="0">请选择物品名称</option>';
            var warId = warNameD.value;
            var kid = classD.value;
            var names = List.data.widKidNameCodeSelects[warId][kid];
            if( warId != 0 || kid != 0 ){
                for(var key in names){
                    for(var i=0;i < names[key].length;i++){
                        nameD.innerHTML = op += "<option value='" + names[key][i].itemInfoId +"'>" + key + "</option>";
                    }
                };
            }
        };
        nameD.onchange= function(){
            getCodeNum();
        };

        //获取编号及现有数
        function getCodeNum(){
            var warId = warNameD.value;
            var kid = classD.value;
            var names = List.data.widKidNameCodeSelects[warId][kid];
            for(var key in names){
                for(var i=0;i < names[key].length;i++){
                    if( warId == 0 || kid == 0 ){
                        $('#myselectCode').val('');
                        $('#nowNum').val('');
                    }else{
                        $('#myselectCode').val(names[key][i].code);
                        $('#nowNum').val(names[key][i].nowNum);
                    }
                }
            };
        }

        var applN = $('#applyNum');
        applN.on('input propertychange', function() {
            var applV =parseInt(applN.val());
			var nowNum = parseInt($('#nowNum').val());
            if(applV > nowNum){
                toast('申请数不能大于现有数！')
			}
        });
        var imgNum = 9;
        // 上传照片
        function uploadImg(){
            if(imgNum <= 0 ){
                toast("最多上传九张");
                return;
            }
            var Multiplechoice = api.require('Multiplechoice');
            Multiplechoice.choice({
                maxstr : imgNum,
                uploadflowUrl:uploadImageUrl
            },function(ret,err){
                imgNum = imgNum-ret.allimgjs.length;
                if(ret.allimgjs.length>0){
                    for(var i=0;i<ret.allimgjs.length;i++){
                        var objimg = {};
                        objimg.img = ret.allimgjs[i];
                        objimg.flag = true;
                        imglist.push(objimg.img);
                        //处理图片变形
                        var width = 41;
                        var height = 41;
                        var obj = getImgByThisSize(objimg.img,width,height);
                        document.getElementById("imglist1").innerHTML +="<span onclick='Endes(this)' style='width:41px;height:41px;overflow:hidden;'><img src='"+objimg.img+"' style='"+obj.style+"' /><i>X</i></span>";
                    }
                }else{
                    toast('上传失败')
                }
            })
        };
        // 删除
        function Endes(self){
            $(self).hide();
            var actionUrl = self.firstChild.getAttribute("src");
            for(var i=0;i<imglist.length;i++){
                if(imglist[i] == actionUrl){
                    imglist.splice(i,1);
                    imgNum++;
                }
            }
        }
		// 提交
        function apply(){
            var applyTime = $api.val($api.byId('pickDateBtn')); //申请时间
            var myselectClass = $('#myselectClass option:selected').val(); //资产类别
            var myselectName = $('#myselectName option:selected').val(); //仓库名
            var myselectWname = $('#myselectWname option:selected').val(); //资产名
            var nowNum = $api.val($api.byId('nowNum')); //现有数
            var applyNum = $api.val($api.byId('applyNum')); //申请数
            var myselectUse = $('#myselectUse option:selected').val(); //使用部门
            var myselectCode = $('#myselectWname').val(); //申请编号
            var desc = $api.val($api.byId('desc')); //获取备注

           	if(applyTime == ''){
                toast('请选择申请时间');
            }else if(myselectName == 0){
                toast('请选择仓库名称');
            }else if(myselectClass == 0){
                toast('请选择资产类别');
            }else if(myselectWname == 0){
                toast('请选择物品名称');
            }else if(nowNum == ''){
                toast('请填写现有数');
            }else if(myselectUse == 0){
                toast('请选择使用部门');
            }else if(applyNum == ''){
                toast('请填写申请数');
            }else{
                var parms = {
                    sid:getUserInfo().sid, //学校ID
                    kid:myselectClass, //分类ID
					name:myselectWname,//资产名
					wid:myselectName,//仓库
                    itemInfoId:myselectCode, //编码集合id
                    did:myselectUse,//申请部门
                    num:applyNum, //申请数量
                    desc:desc, //说明
                    reqTime:Date.parse(applyTime) / 1000,//申请时间
                    images:imglist,//图片数zhu
                    type:2, //2是 申请
                }
                api.showProgress({
                    title: '请求中...',
                    text: '请稍等...',
                    modal: false

                });
                ajaxGet(applyWarehouse,parms,function(ret,err){
                    if(ret.success){
                        api.hideProgress();
                        toast('提交成功，待园长审核!');
                        api.execScript({
                            name: 'applying',
                            frameName: 'applying_body',
                            script: 'apiready()',
                        });
                        setTimeout('closeWin()','2000');
                    }else if(ret.success == false){
                        api.hideProgress();
                        toast(ret.msg);
                    }
                });
            }
        };
	</script>
</html>
